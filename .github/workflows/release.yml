name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      notarize:
        description: "Run notarization (requires notarization secrets)"
        type: boolean
        default: true

jobs:
  build-sign-release:
    name: macOS Release Build
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select Xcode
        run: |
          sudo xcode-select -s "/Applications/Xcode_26.2.app"
          xcodebuild -version

      - name: Install XcodeGen
        run: |
          set -euo pipefail
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi

      - name: Install create-dmg
        run: |
          set -euo pipefail
          if ! command -v create-dmg >/dev/null 2>&1; then
            brew install create-dmg
          fi

      - name: Generate Xcode project
        run: make xcodegen

      - name: Import signing certificate
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          if [[ -z "${MACOS_CERT_P12}" || -z "${MACOS_CERT_PASSWORD}" || -z "${MACOS_KEYCHAIN_PASSWORD}" ]]; then
            echo "Missing signing secrets. Configure MACOS_CERT_P12, MACOS_CERT_PASSWORD, MACOS_KEYCHAIN_PASSWORD." >&2
            exit 1
          fi
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          CERT_PATH="$RUNNER_TEMP/cert.p12"
          echo "$MACOS_CERT_P12" | base64 --decode > "$CERT_PATH"
          security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign
          # Allow codesign (and other Apple tools) to access the key non-interactively.
          security set-key-partition-list -S apple-tool:,apple: -s -k "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Build (Release)
        run: |
          set -euo pipefail
          # Build unsigned to avoid Xcode/SPM signing conflicts. We'll sign explicitly later.
          make build-universal-ci

      - name: Debug signing failure
        if: failure()
        run: |
          set -euo pipefail
          echo "--- Keychains"
          security list-keychains -d user
          echo "--- Code signing identities"
          security find-identity -v -p codesigning || true
          echo "--- App location (if any)"
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData \
            \( -path "*/Build/Products/Release/Podcast Transfer.app" -o -path "*/Build/Products/Release/PodcastTransfer.app" \) \
            -print -quit || true)
          echo "APP_PATH=$APP_PATH"
          if [[ -n "$APP_PATH" ]]; then
            echo "--- codesign details"
            codesign -dv --verbose=4 "$APP_PATH" || true
            echo "--- spctl assessment"
            spctl -a -vv "$APP_PATH" || true
          fi

      - name: Locate app
        run: |
          set -euo pipefail
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData \
            \( -path "*/Build/Products/Release/Podcast Transfer.app" -o -path "*/Build/Products/Release/PodcastTransfer.app" \) \
            -print -quit)
          if [[ -z "$APP_PATH" ]]; then
            echo "Release app not found." >&2
            exit 1
          fi
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"

      - name: Codesign app (Developer ID)
        env:
          CODE_SIGN_IDENTITY: ${{ secrets.MACOS_CODE_SIGN_IDENTITY }}
        run: |
          set -euo pipefail
          if [[ -z "${APP_PATH:-}" ]]; then
            echo "APP_PATH is not set." >&2
            exit 1
          fi
          if [[ -z "${CODE_SIGN_IDENTITY}" ]]; then
            echo "Missing signing identity. Configure MACOS_CODE_SIGN_IDENTITY." >&2
            exit 1
          fi

          # Sign the app bundle for notarization (hardened runtime + timestamp).
          codesign --force --deep --options runtime --timestamp --sign "$CODE_SIGN_IDENTITY" "$APP_PATH"
          codesign --verify --deep --strict --verbose=4 "$APP_PATH"

      - name: Package app (for notarization)
        run: |
          set -euo pipefail
          if [[ -z "${APP_PATH:-}" ]]; then
            echo "APP_PATH is not set." >&2
            exit 1
          fi
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "PodcastTransfer.zip"

      - name: Notarize (notarytool)
        if: ${{ github.event_name == 'push' || inputs.notarize }}
        env:
          MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
          MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}
          MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${MACOS_NOTARY_KEY_ID}" || -z "${MACOS_NOTARY_ISSUER_ID}" || -z "${MACOS_NOTARY_KEY}" ]]; then
            echo "Missing notarization secrets. Configure MACOS_NOTARY_KEY_ID, MACOS_NOTARY_ISSUER_ID, MACOS_NOTARY_KEY." >&2
            exit 1
          fi
          KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$MACOS_NOTARY_KEY" | base64 --decode > "$KEY_PATH"

          echo "Submitting for notarization..."
          xcrun notarytool submit "PodcastTransfer.zip" \
            --key "$KEY_PATH" \
            --key-id "$MACOS_NOTARY_KEY_ID" \
            --issuer "$MACOS_NOTARY_ISSUER_ID" \
            --wait \
            --output-format json | tee "$RUNNER_TEMP/notarytool.json"

            SUBMISSION_ID=$(python3 -c "import json,sys; print(json.load(open(sys.argv[1])).get('id',''))" "$RUNNER_TEMP/notarytool.json")

          if [[ -n "$SUBMISSION_ID" ]]; then
            echo "NOTARY_SUBMISSION_ID=$SUBMISSION_ID" >> "$GITHUB_ENV"
          fi

      - name: Staple notarization ticket
        if: ${{ github.event_name == 'push' || inputs.notarize }}
        run: |
          set -euo pipefail
          if [[ -z "${APP_PATH:-}" ]]; then
            echo "APP_PATH is not set." >&2
            exit 1
          fi
          xcrun stapler staple "$APP_PATH"

      - name: Repackage stapled app
        if: ${{ github.event_name == 'push' || inputs.notarize }}
        run: |
          set -euo pipefail
          if [[ -z "${APP_PATH:-}" ]]; then
            echo "APP_PATH is not set." >&2
            exit 1
          fi
          rm -f "PodcastTransfer.zip"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "PodcastTransfer.zip"

      - name: Create drag-and-drop DMG (pretty)
        run: |
          set -euo pipefail
          if [[ -z "${APP_PATH:-}" ]]; then
            echo "APP_PATH is not set." >&2
            exit 1
          fi

          bash Scripts/create_dmg.sh --app-path "$APP_PATH" --output "PodcastTransfer.dmg"

      - name: Notarize DMG (notarytool)
        if: ${{ github.event_name == 'push' || inputs.notarize }}
        env:
          MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
          MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}
          MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${MACOS_NOTARY_KEY_ID}" || -z "${MACOS_NOTARY_ISSUER_ID}" || -z "${MACOS_NOTARY_KEY}" ]]; then
            echo "Missing notarization secrets. Configure MACOS_NOTARY_KEY_ID, MACOS_NOTARY_ISSUER_ID, MACOS_NOTARY_KEY." >&2
            exit 1
          fi
          if [[ ! -f "PodcastTransfer.dmg" ]]; then
            echo "PodcastTransfer.dmg not found." >&2
            exit 1
          fi

          KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$MACOS_NOTARY_KEY" | base64 --decode > "$KEY_PATH"

          echo "Submitting DMG for notarization..."
          xcrun notarytool submit "PodcastTransfer.dmg" \
            --key "$KEY_PATH" \
            --key-id "$MACOS_NOTARY_KEY_ID" \
            --issuer "$MACOS_NOTARY_ISSUER_ID" \
            --wait

      - name: Staple notarization ticket (DMG)
        if: ${{ github.event_name == 'push' || inputs.notarize }}
        run: |
          set -euo pipefail
          if [[ ! -f "PodcastTransfer.dmg" ]]; then
            echo "PodcastTransfer.dmg not found." >&2
            exit 1
          fi
          xcrun stapler staple "PodcastTransfer.dmg"

      - name: Debug notarization failure
        if: failure()
        env:
          MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
          MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}
          MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}
        run: |
          set -euo pipefail
          echo "--- Notarytool output (if any)"
          if [[ -f "$RUNNER_TEMP/notarytool.json" ]]; then
            cat "$RUNNER_TEMP/notarytool.json"
          fi
          if [[ -n "${NOTARY_SUBMISSION_ID:-}" ]]; then
            KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
            if [[ -z "${MACOS_NOTARY_KEY}" || -z "${MACOS_NOTARY_KEY_ID}" || -z "${MACOS_NOTARY_ISSUER_ID}" ]]; then
              echo "Notarytool credentials missing for log fetch." >&2
            else
              echo "$MACOS_NOTARY_KEY" | base64 --decode > "$KEY_PATH"
              xcrun notarytool log "$NOTARY_SUBMISSION_ID" \
                --key "$KEY_PATH" \
                --key-id "$MACOS_NOTARY_KEY_ID" \
                --issuer "$MACOS_NOTARY_ISSUER_ID" || true
            fi
          fi
          if [[ -n "${APP_PATH:-}" ]]; then
            echo "--- codesign details"
            codesign -dv --verbose=4 "$APP_PATH" || true
            echo "--- spctl assessment"
            spctl -a -vv "$APP_PATH" || true
          fi

      - name: Verify GitHub Release exists (tag pushes)
        if: ${{ github.event_name == 'push' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG_NAME="${GITHUB_REF_NAME}"
          echo "Checking for existing GitHub Release for tag: ${TAG_NAME}"
          if ! gh release view "$TAG_NAME" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "GitHub Release for tag '${TAG_NAME}' not found." >&2
            echo "Create the release (with notes/changelog) first, then re-run this workflow." >&2
            exit 1
          fi

      - name: Upload release assets (tag pushes)
        if: ${{ github.event_name == 'push' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG_NAME="${GITHUB_REF_NAME}"
          if [[ ! -f "PodcastTransfer.dmg" || ! -f "PodcastTransfer.zip" ]]; then
            echo "Release artifacts missing (expected PodcastTransfer.dmg and PodcastTransfer.zip)." >&2
            exit 1
          fi

          gh release upload "$TAG_NAME" \
            "PodcastTransfer.dmg" \
            "PodcastTransfer.zip" \
            --repo "$GITHUB_REPOSITORY" \
            --clobber

      - name: Upload artifacts (manual runs)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: PodcastTransfer
          path: |
            PodcastTransfer.dmg
            PodcastTransfer.zip
